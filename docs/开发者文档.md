# 开发者文档

本文件面向二次开发者，概述工程结构与关键模块对接点。

## 项目结构

为避免重复，请参阅结构专用文档：[项目结构.md](docs/项目结构.md)。

## 架构概览

- 数据模型（`relic/`）：`RelicData`、`RelicSlot`、`RelicRarity`、`RelicStatType`
- 存储层（`storage/`）：`RelicInventoryStorage`、`InventoryProfileManager` 等
- 业务层（`service/`）：`RelicEffectService`、`StatAggregationService`、`AttributePlusBridge`、`RelicGenerationService`
- 展示层（`gui/`）：主菜单、装备、仓库 GUI
- 命令层（`command/`）：`/relic` 命令（含 help/list/gen/box）与 Tab 补全
- 管理层（`manager/`）：`RelicManager`（套装+属性池）、`TreasureBoxManager`（宝箱）

## 关键变更（v1.0.0+）

- 新增属性池与随机生成：主/副词条来源、权重与主词条步进
- 新增宝箱系统：配置化外观与掉落权重、右键开启生成
- `/relic list` 支持中文名展示、四件套预览、翻页
- `/relic help` 汇总命令，Tab 补全覆盖 `box/give/gen` 流程

## 属性池与生成（`RelicGenerationService`）

- 配置文件：`relics/attribute_pool.yml`
  - `main_stats.*.base/step/slots`：主词条基础值、每级步进和部位限制
  - `sub_stats.*.weight/pool`：副词条权重与(初始/强化)抽取池
  - `rarity.*`：不同品质的`max_level`与初始副词条数量范围
- 生成规则：
  - 主词条：FLOWER=HP_FLAT，PLUME=ATK_FLAT，其余按 `slots` 候选随机
  - 主词条随等级线性增长可在 `config.yml -> relic.mainstat.scale` 启用
  - 副词条：按权重加权随机且与主/已有副词条去重；每5级新增或强化，最多4条

## 宝箱系统（`TreasureBoxManager`/`TreasureBoxListener`）

- 配置文件：`relics/treasure_box.yml`
  - `display_name/material/custom_model_data/glow` 外观
  - `sets/rarities` 候选集合与 `set_weights/rarity_weights` 权重
- 交互：
  - `TreasureBoxItemFactory` 将 `boxId` 写入 PDC；右键开启触发生成并消耗
  - 命令发放：`/relic box give <player> <boxId> [amount]`

## 命令与补全

- 顶层：`help`、`list [page]`、`open`、`gen`、`box`、`reload`...
- `gen`: setId → slot → rarity → level 的多层补全
- `box give`: player → boxId → amount 的多层补全
- `list`: 支持页码补全（1/2/3...），每页6条

## AttributePlus 深度集成

### API 模式（推荐）

本插件通过反射直接调用 AttributePlus API，无需编译期依赖：

**核心类：** `AttributePlusBridge.java`

**API 调用流程：**
```java
// 1. 获取玩家的 AttributeData
AttributeAPI.getAttrData(player);

// 2. 创建属性源
AttributeAPI.createStaticAttributeSource(
    valueMap,      // HashMap<String, Number[]> - 固定数值
    percentageMap  // HashMap<String, Double> - 百分比
);

// 3. 添加属性源
AttributeAPI.addSourceAttribute(data, namespace, source);

// 4. 触发属性重算（延迟 1 tick）
AttributeAPI.updateAttribute(player);
```

**属性名称映射：**
- 使用 `resolveServerKey()` 方法将英文键转换为中文服务器键
- 例如：`attack` → `物理伤害`，`health` → `生命力`
- 硬编码映射表确保与 AP 的 `attribute.yml` 完全对应

**两种数值类型：**
1. **固定数值**（valueMap）：
   - 格式：`HashMap<String, Number[]>`
   - Number[0] = 最小值，Number[1] = 最大值
   - 例如：`["生命力"] = [100.0, 0]`

2. **百分比**（pctMap）：
   - 格式：`HashMap<String, Double>`
   - 通过 `percent_scale` 缩放
   - 例如：15% → `pctMap["物理伤害"] = 15.0 * percent_scale`

**延迟刷新机制：**
```java
// 在属性设置后延迟 1 tick 调用 updateAttribute
plugin.getServer().getScheduler().runTaskLater(plugin, () -> {
    AttributeAPI.updateAttribute(player);
}, 1L);
```
这确保属性已完全写入后再触发 AP 的重算。

### 命令模式（回退）

如果 API 模式失败，自动回退到命令模式：

**配置：**
```yml
integration:
  attributeplus:
    command_mode:
      enabled: true
      apply_each:
        - "ap set %player% %namespace%:%key% %value%"
      clear_all:
        - "ap clear %player% %namespace%"
```

**占位符：**
- `%player%` - 玩家名称
- `%uuid%` - 玩家 UUID
- `%namespace%` - 命名空间（RelicSystem）
- `%key%` - 属性键（中文）
- `%value%` - 属性值

### 属性类型判定

**自动识别百分比属性：**
```java
// 方式1：通过类型名后缀
boolean pctByType = type.name().endsWith("_PCT");

// 方式2：通过配置的 percentage_keys
boolean pctByKey = percentageKeys.contains(apKey);

// 最终判定
boolean asPercent = pctByType || pctByKey;
```

### 调试与日志

**详细日志输出：**
```java
plugin.getLogger().info("[AP] 准备下发 " + player.getName() + " - percentScale=" + percentScale);
plugin.getLogger().info("[AP] valueMap内容 (固定数值):");
// ... 输出每个属性

plugin.getLogger().info("[AP] pctMap内容 (百分比):");
// ... 输出每个百分比属性
```

**常见问题诊断：**
1. **属性未显示** → 检查 `stat_map` 映射是否正确
2. **百分比异常** → 调整 `percent_scale` 值
3. **API 失败** → 检查 AP 版本兼容性，查看异常堆栈

### 内置属性引擎（回退）

当 AP 未启用时，使用内置引擎：
- 应用原版属性修饰器
- 实现基础战斗计算
- 完全独立运行，无外部依赖

**关键类：**
- `RelicEffectService` - 属性应用与刷新
- `CombatListener` - 战斗事件处理
- `StatAggregationService` - 属性聚合

## 构建与调试

- 推荐根目录执行 `build_jar.bat`（Maven包装）
- 目标 JAR：`target/relic-system-1.0.0.jar`
- Paper 1.20.x，Java 17+

## 开发注意事项

- 数值口径：`attribute_pool.yml` 的百分比类数值按“百分数”理解（如 5.0 表示 5%）。
- 互斥原则：当 `integration.attributeplus.enabled = true` 且服务器已安装 AP 时，内置属性应用与战斗计算自动停用，避免重复结算。
- 原版属性上限：`GENERIC_MOVEMENT_SPEED` 与 `GENERIC_ATTACK_SPEED` 的乘法修饰可能受服务端/客户端上限限制，数值需合理控制。
- 随机性：暴击采用线程本地随机；若需要可重现或统计调试，可替换为可注入的 RNG。
- 自定义扩展：
  - 可在 `RelicEffectService` 内扩展更多原版属性映射（如 HP_FLAT/ATK_FLAT 的额外加成策略）。
  - 可在 `CombatListener` 中按伤害来源（近战/箭矢/魔法）细分不同乘区或特殊效果。
