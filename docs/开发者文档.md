# 开发者文档

本文件面向二次开发者，概述工程结构与关键模块对接点。

## 项目结构

为避免重复，请参阅结构专用文档：[`docs/项目结构.md`](docs/项目结构.md)。

## 架构概览

- 数据模型（`relic/`）：`RelicData`、`RelicSlot`、`RelicRarity`、`RelicStatType`
- 存储层（`storage/`）：`RelicInventoryStorage`、`InventoryProfileManager` 等
- 业务层（`service/`）：`RelicEffectService`、`StatAggregationService`、`AttributePlusBridge`、`RelicGenerationService` 🆕
- 展示层（`gui/`）：主菜单、装备、仓库 GUI
- 命令层（`command/`）：`/relic` 命令（含 help/list/gen/box）与 Tab 补全
- 管理层（`manager/`）：`RelicManager`（套装+属性池）、`TreasureBoxManager`（宝箱）🆕

## 关键变更（v1.0.0+）

- 新增属性池与随机生成：主/副词条来源、权重与主词条步进
- 新增宝箱系统：配置化外观与掉落权重、右键开启生成
- `/relic list` 支持中文名展示、四件套预览、翻页
- `/relic help` 汇总命令，Tab 补全覆盖 `box/give/gen` 流程

## 属性池与生成（`RelicGenerationService`）

- 配置文件：`relics/attribute_pool.yml`
  - `main_stats.*.base/step/slots`：主词条基础值、每级步进和部位限制
  - `sub_stats.*.weight/pool`：副词条权重与(初始/强化)抽取池
  - `rarity.*`：不同品质的`max_level`与初始副词条数量范围
- 生成规则：
  - 主词条：FLOWER=HP_FLAT，PLUME=ATK_FLAT，其余按 `slots` 候选随机
  - 主词条随等级线性增长可在 `config.yml -> relic.mainstat.scale` 启用
  - 副词条：按权重加权随机且与主/已有副词条去重；每5级新增或强化，最多4条

## 宝箱系统（`TreasureBoxManager`/`TreasureBoxListener`）

- 配置文件：`relics/treasure_box.yml`
  - `display_name/material/custom_model_data/glow` 外观
  - `sets/rarities` 候选集合与 `set_weights/rarity_weights` 权重
- 交互：
  - `TreasureBoxItemFactory` 将 `boxId` 写入 PDC；右键开启触发生成并消耗
  - 命令发放：`/relic box give <player> <boxId> [amount]`

## 命令与补全

- 顶层：`help`、`list [page]`、`open`、`gen`、`box`、`reload`...
- `gen`: setId → slot → rarity → level 的多层补全
- `box give`: player → boxId → amount 的多层补全
- `list`: 支持页码补全（1/2/3...），每页6条

## 集成（AttributePlusBridge）

- `config.yml -> integration.attributeplus`：开启、命名空间、映射表
- 运行期通过 `AttributePlusBridge.apply/clear` 对接（当前为占位日志）

## 构建与调试

- 推荐根目录执行 `build_jar.bat`（Maven包装）
- 目标 JAR：`target/relic-system-1.0.0.jar`
- Paper 1.20.x，Java 17+
