# 开发者文档

本文件面向二次开发者，概述工程结构与关键模块对接点。

## 项目结构

为避免重复，请参阅结构专用文档：[项目结构.md](docs/项目结构.md)。

## 架构概览

- 数据模型（`relic/`）：`RelicData`、`RelicSlot`、`RelicRarity`、`RelicStatType`
- 存储层（`storage/`）：`RelicInventoryStorage`、`InventoryProfileManager` 等
- 业务层（`service/`）：`RelicEffectService`、`StatAggregationService`、`AttributePlusBridge`、`RelicGenerationService`
- 展示层（`gui/`）：主菜单、装备、仓库 GUI
- 命令层（`command/`）：`/relic` 命令（含 help/list/gen/box）与 Tab 补全
- 管理层（`manager/`）：`RelicManager`（套装+属性池）、`TreasureBoxManager`（宝箱）

## 关键变更（v1.0.0+）

- 新增属性池与随机生成：主/副词条来源、权重与主词条步进
- 新增宝箱系统：配置化外观与掉落权重、右键开启生成
- `/relic list` 支持中文名展示、四件套预览、翻页
- `/relic help` 汇总命令，Tab 补全覆盖 `box/give/gen` 流程

## 属性池与生成（`RelicGenerationService`）

- 配置文件：`relics/attribute_pool.yml`
  - `main_stats.*.base/step/slots`：主词条基础值、每级步进和部位限制
  - `sub_stats.*.weight/pool`：副词条权重与(初始/强化)抽取池
  - `rarity.*`：不同品质的`max_level`与初始副词条数量范围
- 生成规则：
  - 主词条：FLOWER=HP_FLAT，PLUME=ATK_FLAT，其余按 `slots` 候选随机
  - 主词条随等级线性增长可在 `config.yml -> relic.mainstat.scale` 启用
  - 副词条：按权重加权随机且与主/已有副词条去重；每5级新增或强化，最多4条

## 宝箱系统（`TreasureBoxManager`/`TreasureBoxListener`）

- 配置文件：`relics/treasure_box.yml`
  - `display_name/material/custom_model_data/glow` 外观
  - `sets/rarities` 候选集合与 `set_weights/rarity_weights` 权重
- 交互：
  - `TreasureBoxItemFactory` 将 `boxId` 写入 PDC；右键开启触发生成并消耗
  - 命令发放：`/relic box give <player> <boxId> [amount]`

## 命令与补全

- 顶层：`help`、`list [page]`、`open`、`gen`、`box`、`reload`...
- `gen`: setId → slot → rarity → level 的多层补全
- `box give`: player → boxId → amount 的多层补全
- `list`: 支持页码补全（1/2/3...），每页6条

## 属性引擎与 AP 兼容

- 内置属性引擎（无依赖）：
  - 聚合词条于 `RelicEffectService` 并缓存供战斗读取
  - 应用原版属性（当 AP 未启用）：
    - ATK_SPEED(%) → `GENERIC_ATTACK_SPEED`（值/100，乘法修饰）
    - MOVE_SPEED(%) → `GENERIC_MOVEMENT_SPEED`（值/100，乘法修饰）
    - LUCK(+) → `GENERIC_LUCK`（加法修饰）
    - KB_RES(%) → `GENERIC_KNOCKBACK_RESISTANCE`（值/100→0..1，加法修饰）
  - 战斗计算（`CombatListener`，当 AP 未启用）：
    - 伤害乘区：ATK_PCT、ELEM_DMG_ANY
    - 暴击：CRIT_RATE 判定，CRIT_DMG 为额外乘区
    - 减伤：DEF_PCT 作为最终乘区近似（damage *= 1 - DEF_PCT）

- AP 兼容（可选）：
  - 配置：`config.yml -> integration.attributeplus`
    - `enabled`: true/false（启用即让位给 AP，内置战斗与属性应用自动跳过，避免冲突）
    - `namespace`: 写入命名空间前缀
    - `stat_map`: `RelicStatType` → AP 键映射
    - `command_mode.enabled`: true/false（使用控制台命令桥接 AP）
    - `command_mode.apply_each`: 针对每一对键值的设置命令模板（占位符：`%player%/%uuid%/%namespace%/%key%/%value%`）
    - `command_mode.clear_all`: 清理命名空间的命令模板
  - 运行期：通过 `AttributePlusBridge.apply/clear` 分发或清理；若未来引入 AP 官方 API，可在 Bridge 内切换为直连 API。

## 构建与调试

- 推荐根目录执行 `build_jar.bat`（Maven包装）
- 目标 JAR：`target/relic-system-1.0.0.jar`
- Paper 1.20.x，Java 17+

## 开发注意事项

- 数值口径：`attribute_pool.yml` 的百分比类数值按“百分数”理解（如 5.0 表示 5%）。
- 互斥原则：当 `integration.attributeplus.enabled = true` 且服务器已安装 AP 时，内置属性应用与战斗计算自动停用，避免重复结算。
- 原版属性上限：`GENERIC_MOVEMENT_SPEED` 与 `GENERIC_ATTACK_SPEED` 的乘法修饰可能受服务端/客户端上限限制，数值需合理控制。
- 随机性：暴击采用线程本地随机；若需要可重现或统计调试，可替换为可注入的 RNG。
- 自定义扩展：
  - 可在 `RelicEffectService` 内扩展更多原版属性映射（如 HP_FLAT/ATK_FLAT 的额外加成策略）。
  - 可在 `CombatListener` 中按伤害来源（近战/箭矢/魔法）细分不同乘区或特殊效果。
