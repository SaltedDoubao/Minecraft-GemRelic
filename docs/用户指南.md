# 用户指南

本指南帮助服主快速部署与调优 Minecraft Relic System 圣遗物系统。

## 安装

1. 服务器环境：Paper 1.20.x，Java 17+
2. 将 `target/relic-system-1.0.0.jar` 放入 `plugins/`
3. 首次启动生成默认配置与资源文件

## 命令总览

- 玩家命令（权限：`mrs.user`）
  - `/relic help`：查看命令帮助与说明
  - `/relic gui`：打开圣遗物系统主菜单（GUI）
  - `/relic list [page]`：查看已配置套装（中文名+四件套预览，支持翻页）
  - `/relic stats`：查看当前装备的遗物属性汇总（**新增**）
  - `/relic refresh`：手动刷新遗物属性到 AttributePlus（**新增**）

- 管理员命令（权限：`mrs.admin`）
  - `/relic reload`：重载圣遗物配置（套装/属性池/宝箱等）
  - `/relic gen <setId> <slot|ALL> <rarity> <level>`：生成并发放圣遗物到背包
  - `/relic give <player> <setId> <slot|ALL> <rarity> <level>`：向玩家发放指定圣遗物
  - `/relic box give <player> <boxId> [amount]`：发放宝箱道具
  - `/relic migrate`：将旧数据迁移到独立存储系统
  - `/relic migration-status`：查看数据迁移状态

## 配置文件总览

- `config.yml`：主配置（主词条步进、AP集成）
- `relics/sets.yml`：套装与描述
- `relics/attribute_pool.yml`：属性池与权重
- `relics/treasure_box.yml`：宝箱外观与掉落

## 主词条步进（提升成长曲线）

`config.yml`
```yml
relic:
  mainstat:
    scale: true        # 启用主词条随等级线性增长（base + level*step）
    step_default: 1.0  # 属性池未定义 step 时的默认步进
```
`relics/attribute_pool.yml`
```yml
main_stats:
  ATK_PCT:
    slots: [SANDS, GOBLET, CIRCLET]
    base: 6.0
    step: 1.2
```

## 副词条掉率权重（拉长养成）

- 在 `sub_stats.*.weight` 配置权重，数值越大越常见
- 推荐：降低暴击词条权重以拉长毕业周期
```yml
sub_stats:
  CRIT_RATE:
    weight: 1
    pool: [3.1, 3.5, 3.9, 4.3]
  CRIT_DMG:
    weight: 2
    pool: [6.2, 7.0, 7.8, 8.6]
  ATK_PCT:
    weight: 10
    pool: [4.1, 4.7, 5.3, 5.8]
```
- 规则：生成/升级每5级新增或强化一条，最多4条；抽取时与主/已有副词条去重

## 宝箱道具（自定义外观 + 权重）

`relics/treasure_box.yml`
```yml
boxes:
  starter_box:
    display_name: "§6新手圣遗物宝箱"
    material: CHEST
    custom_model_data: 10001
    glow: false
    lore:
      - "§7打开可获得随机圣遗物"
    sets: [gladiator]
    rarities: [WHITE, GREEN, BLUE]
    set_weights:
      gladiator: 1
    rarity_weights:
      WHITE: 60
      GREEN: 30
      BLUE: 10
```
- 发放：`/relic box give 玩家 starter_box 3`
- 玩家右键开启消耗并获得圣遗物

## AttributePlus 集成（推荐）

本插件已深度集成 AttributePlus，提供完整的属性支持：

### 启用 AP 集成

`config.yml`：
```yml
integration:
  attributeplus:
    enabled: true              # 启用 AP 集成
    namespace: RelicSystem     # 命名空间
    api_mode: true             # 使用 API 模式（推荐）
    percent_scale: 1.0         # 百分比缩放（通常为 1.0 或 0.01）
```

### 属性名称对应

本插件的属性名称已完全对应 AttributePlus：
- **生命力**（HP_FLAT/HP_PCT）→ health
- **物理伤害**（ATK_FLAT/ATK_PCT）→ attack
- **物理防御**（DEF_FLAT/DEF_PCT）→ defense
- **暴击几率**（CRIT_CHANCE）→ crit
- **暴击倍率**（CRIT_RATE）→ crit_rate
- 其他属性详见 `config.yml`

### 验证集成

1. 装备圣遗物后执行 `/relic stats` 查看属性汇总
2. 执行 `/ap stats` 查看 AP 面板，应显示 "RelicSystem" 来源的属性
3. 如果属性未同步，执行 `/relic refresh` 手动刷新

### 日志调试

启用调试模式查看详细日志：
```yml
settings:
  debug: true
```

日志示例：
```
[AP] 准备下发 PlayerName - percentScale=1.0
[AP] valueMap内容 (固定数值):
  [生命力] = [min:100.0, max:0]
[AP] pctMap内容 (百分比):
  [物理伤害] = 15.0
[AP] addSourceAttribute 调用成功
[AP] updateAttribute 调用成功
```

### 百分比格式说明

如果 `/ap stats` 显示的百分比异常（过大或过小），调整 `percent_scale`：
- 若显示 15000% 而不是 15%：设置 `percent_scale: 0.01`
- 若显示 0.15% 而不是 15%：设置 `percent_scale: 100`

## 内置属性引擎（无 AP 时）

如果未安装 AttributePlus，插件会使用内置属性引擎：
- 原版属性映射：移速、生命值等
- 战斗计算：暴击、伤害加成等
- 完全独立运行，无需外部依赖

## 常见调优建议

- 想让毕业更慢：降低 `CRIT_RATE/CRIT_DMG` 权重；提升 `DEF_PCT/HP_FLAT/ATK_FLAT` 权重
- 想让速度流更常见：提升 `ATK_SPEED/MOVE_SPEED` 权重
- 控制产出强度：降低主词条 `base/step` 或关闭 `relic.mainstat.scale`

## 故障排查

- 配置未生效：确认改动后执行 `/relic reload`
- 生成失败：检查 `sets.yml` 是否存在对应 `setId`
- 宝箱无反应：确认手持为自定义宝箱（PDC 标记），并检查监听加载

---
如需进阶自定义，请参阅《开发者文档.md》。
